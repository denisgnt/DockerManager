version: '3.8'

services:
  docker-manager:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: docker-manager
    restart: unless-stopped
    # Required for nsenter to access host namespaces
    privileged: true
    pid: host
    ports:
      - "${VITE_PORT:-3011}:${VITE_BACKEND_PORT:-5005}"
    volumes:
      # Mount scripts directory
      - ${SCRIPTS_DIR:-/home/axitech/BPM2}:/app/scripts:ro
      # Mount data directory for persistent storage
      - ./data:/app/data
    environment:
      # Docker API Configuration
      - VITE_DOCKER_API_HOST=${VITE_DOCKER_API_HOST:-localhost}
      - VITE_DOCKER_API_PORT=${VITE_DOCKER_API_PORT:-2375}
      # Server Port (в production только backend на 5005)
      - VITE_BACKEND_PORT=${VITE_BACKEND_PORT:-5005}
      # Scripts Directory (internal path in container)
      - SCRIPTS_DIR=/app/scripts
      # Host Scripts Directory (path on host machine for docker run)
      - HOST_SCRIPTS_DIR=${SCRIPTS_DIR:-/home/axitech/BPM2}
      # Application Name
      - VITE_APP_NAME=${VITE_APP_NAME:-Docker Manager DEFAULT}
      # Force production mode
      - NODE_ENV=production
    networks:
      - docker-manager-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${VITE_BACKEND_PORT:-5005}/api/containers"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  docker-manager-network:
    driver: bridge
