# ๐ ะะฐะฟััะบ ัะบัะธะฟัะพะฒ ะฝะฐ ัะพััะต ะธะท Docker ะบะพะฝัะตะนะฝะตัะฐ

## ะัะพะฑะปะตะผะฐ

ะะพ ัะผะพะปัะฐะฝะธั ัะบัะธะฟัั `UP_*.sh` ะทะฐะฟััะบะฐะปะธัั **ะฒะฝัััะธ** ะบะพะฝัะตะนะฝะตัะฐ Docker Manager, ะฐ ะฝะต ะฝะฐ ัะพัั-ะผะฐัะธะฝะต. ะญัะพ ะฝะตะฟัะฐะฒะธะปัะฝะพ, ัะฐะบ ะบะฐะบ ัะบัะธะฟัั ะดะพะปะถะฝั ัะฟัะฐะฒะปััั ะบะพะฝัะตะนะฝะตัะฐะผะธ ะฝะฐ ัะพััะต.

## ะะตัะตะฝะธะต

ะกะบัะธะฟัั ัะตะฟะตัั ะทะฐะฟััะบะฐัััั **ะฝะฐ ัะพัั-ะผะฐัะธะฝะต** ัะตัะตะท Docker socket.

---

## ๐๏ธ ะััะธัะตะบัััะฐ

### ะัะปะพ (ะฝะตะฟัะฐะฒะธะปัะฝะพ):
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Docker Manager Container       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ bash UP_script.sh         โ  โ โ ะกะบัะธะฟั ะฒะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะกัะฐะปะพ (ะฟัะฐะฒะธะปัะฝะพ):
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Host Machine (PID namespace)               โ
โ  โโ PID 1 (init)                            โ
โ  โโ bash script.sh โ ะกะบัะธะฟั ะฝะฐ ัะพััะต        โ
โ  โ                                           โ
โ  โโ Docker Container                        โ
โ     โโ privileged: true                     โ
โ     โโ pid: host                            โ
โ     โโ nsenter --target 1 ... bash script โโโ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะัะตะธะผััะตััะฒะฐ:**
- โ ะะตั ะฒัะตะผะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ
- โ ะััััะตะต (ะฟััะผะพะน ะทะฐะฟััะบ)
- โ ะะตะฝััะต ะฝะฐะบะปะฐะดะฝัั ัะฐััะพะดะพะฒ

---

## ๐ ะงัะพ ะธะทะผะตะฝะธะปะพัั

### 1. docker-compose.yml

ะะพะฑะฐะฒะปะตะฝั ะฟัะธะฒะธะปะตะณะธะธ ะดะปั ะดะพัััะฟะฐ ะบ host namespace:
```yaml
services:
  docker-manager:
    privileged: true  # โ ะะตะพะฑัะพะดะธะผะพ ะดะปั nsenter
    pid: host         # โ ะะพัััะฟ ะบ PID namespace ัะพััะฐ
    volumes:
      - ${SCRIPTS_DIR}:/app/scripts:ro

environment:
  - HOST_SCRIPTS_DIR=${SCRIPTS_DIR:-/home/axitech/BPM2}
```

### 2. Dockerfile

ะฃััะฐะฝะพะฒะปะตะฝ util-linux (ัะพะดะตัะถะธั nsenter):
```dockerfile
RUN apk add --no-cache \
    wget \
    bash \
    util-linux  # provides nsenter
```

### 3. server/index.js

ะกะบัะธะฟัั ะทะฐะฟััะบะฐัััั ัะตัะตะท nsenter:
```javascript
// ะัะฟะพะปัะทะพะฒะฐะฝะธะต nsenter ะดะปั ะฒัะพะดะฐ ะฒ namespace ัะพััะฐ
const command = `nsenter --target 1 --mount --uts --ipc --net --pid -- bash "${hostScriptPath}"`
```

---

## ๐ง ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

1. **Docker Manager** ะทะฐะฟััะตะฝ ั `privileged: true` ะธ `pid: host`
2. ะะพะฝัะตะนะฝะตั ะธะผะตะตั ะดะพัััะฟ ะบ PID namespace ัะพััะฐ
3. ะัะฟะพะปัะทัะตััั `nsenter` ะดะปั ะฒัะพะดะฐ ะฒ namespace ะฟัะพัะตััะฐ ั PID 1 (init ะฝะฐ ัะพััะต)
4. ะกะบัะธะฟั ะฒัะฟะพะปะฝัะตััั **ะฝะฐะฟััะผัั ะฝะฐ ัะพััะต** ะฒ ะบะพะฝัะตะบััะต ัะพััะฐ
5. ะัะต ะบะพะผะฐะฝะดั Docker ะฒ ัะบัะธะฟัะต ัะฐะฑะพัะฐัั ั Docker daemon ัะพััะฐ

**nsenter** - ััะพ ััะธะปะธัะฐ Linux ะดะปั ะฒัะพะดะฐ ะฒ namespace ะดััะณะพะณะพ ะฟัะพัะตััะฐ:
- `--target 1` - ัะตะปะตะฒะพะน ะฟัะพัะตัั (PID 1 = init ัะพััะฐ)
- `--mount` - ะฒะพะนัะธ ะฒ mount namespace
- `--uts` - ะฒะพะนัะธ ะฒ UTS namespace (hostname)
- `--ipc` - ะฒะพะนัะธ ะฒ IPC namespace
- `--net` - ะฒะพะนัะธ ะฒ network namespace  
- `--pid` - ะฒะพะนัะธ ะฒ PID namespace

**ะะตะทัะปััะฐั:** ะกะบัะธะฟั ะฒัะฟะพะปะฝัะตััั ัะฐะบ, ะบะฐะบ ะฑัะดัะพ ะฒั ะทะฐะฟัััะธะปะธ ะตะณะพ ะฟััะผะพ ะฝะฐ ัะพััะต!

---

## โ๏ธ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

### ะ .env ัะฐะนะปะต:

```env
# ะััั ะบ ัะบัะธะฟัะฐะผ ะฝะฐ ัะพัั-ะผะฐัะธะฝะต
SCRIPTS_DIR=/home/axitech/BPM2
```

### ะ docker-compose.yml (ะฐะฒัะพะผะฐัะธัะตัะบะธ):

```yaml
- SCRIPTS_DIR=/app/scripts           # ะะฝัััะตะฝะฝะธะน ะฟััั ะฒ ะบะพะฝัะตะนะฝะตัะต
- HOST_SCRIPTS_DIR=/home/axitech/BPM2  # ะััั ะฝะฐ ัะพััะต
```

---

## โ ะัะตะธะผััะตััะฒะฐ ะฝะพะฒะพะณะพ ะฟะพะดัะพะดะฐ

1. **ะััะผะพะต ะฒัะฟะพะปะฝะตะฝะธะต** - ะฑะตะท ะฒัะตะผะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ
2. **ะััััะตะต** - ะฝะตั ะฝะฐะบะปะฐะดะฝัั ัะฐััะพะดะพะฒ ะฝะฐ ัะพะทะดะฐะฝะธะต/ัะดะฐะปะตะฝะธะต ะบะพะฝัะตะนะฝะตัะฐ
3. **ะัะพัะต** - ะฝะต ะฝัะถะตะฝ Docker socket ะธะปะธ Docker CLI
4. **ะะพะปะฝัะน ะดะพัััะฟ** - ัะบัะธะฟั ัะฐะฑะพัะฐะตั ะฒ ะบะพะฝัะตะบััะต ัะพััะฐ
5. **ะะตะฝััะต ะทะฐะฒะธัะธะผะพััะตะน** - ัะพะปัะบะพ nsenter (ะฒัะพะดะธั ะฒ util-linux)

---

## ๐ ะะตะทะพะฟะฐัะฝะพััั

### Privileged ัะตะถะธะผ ะธ pid: host

โ๏ธ **ะะฐะถะฝะพ:** `privileged: true` ะธ `pid: host` ะดะฐัั ะบะพะฝัะตะนะฝะตัั ะฟัะฐะบัะธัะตัะบะธ ะฟะพะปะฝัะน ะดะพัััะฟ ะบ ัะพััั!

**ะงัะพ ััะพ ะพะทะฝะฐัะฐะตั:**
- ะะพะฝัะตะนะฝะตั ะผะพะถะตั ะฒัะฟะพะปะฝััั ะบะพะผะฐะฝะดั ะฝะฐ ัะพััะต ัะตัะตะท nsenter
- ะะพะปะฝัะน ะดะพัััะฟ ะบ ัะฐะนะปะพะฒะพะน ัะธััะตะผะต ัะพััะฐ (ะตัะปะธ ะฟัะธะผะพะฝัะธัะพะฒะฐะฝะฐ)
- ะะพัััะฟ ะบะพ ะฒัะตะผ ะฟัะพัะตััะฐะผ ัะพััะฐ
- ะคะฐะบัะธัะตัะบะธ ัะบะฒะธะฒะฐะปะตะฝัะฝะพ root ะดะพัััะฟั

**ะะตะบะพะผะตะฝะดะฐัะธะธ:**
1. ะัะฟะพะปัะทัะนัะต ัะพะปัะบะพ ะฒ ะดะพะฒะตัะตะฝะฝะพะน ัะตัะธ
2. ะะณัะฐะฝะธัััะต ะดะพัััะฟ ะบ ะฟัะธะปะพะถะตะฝะธั ัะตัะตะท ัะฐะนัะฒะพะป
3. ะะตะณัะปััะฝะพ ะฟัะพะฒะตััะนัะต ะปะพะณะธ ะฒัะฟะพะปะฝะตะฝะธั ัะบัะธะฟัะพะฒ
4. ะะปั ะฟัะพะดะฐะบัะตะฝะฐ ัะฐััะผะพััะธัะต ะฑะพะปะตะต ะฑะตะทะพะฟะฐัะฝัะต ะฐะปััะตัะฝะฐัะธะฒั

---

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### 1. ะัะพะฒะตัะบะฐ nsenter

```bash
docker exec docker-manager which nsenter
```

**ะะถะธะดะฐะตััั:**
```
/usr/bin/nsenter
```

### 2. ะัะพะฒะตัะบะฐ PID namespace

```bash
docker exec docker-manager ps aux | head -5
```

**ะะถะธะดะฐะตััั:** ะกะฟะธัะพะบ ะฟัะพัะตััะพะฒ ัะพััะฐ (ะฑะปะฐะณะพะดะฐัั pid: host)

### 3. ะขะตััะพะฒัะน ะทะฐะฟััะบ ัะตัะตะท nsenter

```bash
docker exec docker-manager nsenter --target 1 --mount --pid -- hostname
```

**ะะถะธะดะฐะตััั:** Hostname ัะพัั-ะผะฐัะธะฝั

### 4. ะขะตััะพะฒัะน ะทะฐะฟััะบ ัะบัะธะฟัะฐ

ะกะพะทะดะฐะนัะต ัะตััะพะฒัะน ัะบัะธะฟั `/home/axitech/BPM2/UP_test.sh`:
```bash
#!/bin/bash
echo "Running on host!"
echo "Docker containers:"
docker ps --format "table {{.Names}}\t{{.Status}}"
```

ะะฐะฟัััะธัะต ัะตัะตะท UI ะธะปะธ API:
```bash
curl -X POST http://localhost:3011/api/scripts/execute \
  -H "Content-Type: application/json" \
  -d '{"scriptName": "UP_test.sh", "containerName": "test"}'
```

---

## ๐ ะะพะณะธ

ะัะธ ะฒัะฟะพะปะฝะตะฝะธะธ ัะบัะธะฟัะฐ ะฒ ะปะพะณะฐั ะฑัะดะตั:

```
Executing script on host: /app/scripts/UP_test.sh
Executing command: nsenter --target 1 --mount --uts --ipc --net --pid -- bash "/home/axitech/BPM2/UP_test.sh"
```

---

## ๐ ะัะธะผะตะฝะตะฝะธะต ะธะทะผะตะฝะตะฝะธะน

ะะพัะปะต ะฒัะตั ะธะทะผะตะฝะตะฝะธะน ะฟะตัะตัะพะฑะตัะธัะต ะบะพะฝัะตะนะฝะตั:

```bash
./docker_rebuild.sh
```

ะะปะธ ะฒัััะฝัั:
```bash
docker compose down
docker compose build --no-cache
docker compose up -d
docker logs -f docker-manager
```

---

## ๐ Troubleshooting

### ะัะธะฑะบะฐ: "Operation not permitted"

**ะัะธัะธะฝะฐ:** ะะพะฝัะตะนะฝะตั ะฝะต ะธะผะตะตั ะฝัะถะฝัั ะฟัะธะฒะธะปะตะณะธะน

**ะะตัะตะฝะธะต:** ะัะพะฒะตัััะต docker-compose.yml:
```yaml
services:
  docker-manager:
    privileged: true
    pid: host
```

### ะัะธะฑะบะฐ: "No such file or directory" ะฟัะธ ะทะฐะฟััะบะต ัะบัะธะฟัะฐ

**ะัะธัะธะฝะฐ:** ะะตะฟัะฐะฒะธะปัะฝัะน ะฟััั ะบ ัะบัะธะฟัั ะฝะฐ ัะพััะต

**ะะตัะตะฝะธะต:** ะัะพะฒะตัััะต ะฟะตัะตะผะตะฝะฝัั HOST_SCRIPTS_DIR:
```bash
docker exec docker-manager env | grep HOST_SCRIPTS_DIR
```

### ะกะบัะธะฟั ะฝะต ะฝะฐัะพะดะธั Docker ะบะพะผะฐะฝะดั

**ะัะธัะธะฝะฐ:** ะกะบัะธะฟั ะฒัะฟะพะปะฝัะตััั ะฒ ะบะพะฝัะตะบััะต ัะพััะฐ, ะณะดะต ะผะพะถะตั ะฝะต ะฑััั Docker ะฒ PATH

**ะะตัะตะฝะธะต:** ะ ัะบัะธะฟัะต ะธัะฟะพะปัะทัะนัะต ะฟะพะปะฝัะน ะฟััั:
```bash
#!/bin/bash
/usr/bin/docker ps
# ะธะปะธ
/usr/local/bin/docker ps
```

---

## ๐ ะกัะฐะฒะฝะตะฝะธะต ะฟะพะดัะพะดะพะฒ

| ะะพะดัะพะด | ะัะตะธะผััะตััะฒะฐ | ะะตะดะพััะฐัะบะธ |
|--------|-------------|-----------|
| **ะะฝัััะธ ะบะพะฝัะตะนะฝะตัะฐ** | ะัะพััะพ | ะะตั ะดะพัััะฟะฐ ะบ ัะพััั, ะฝะตะฟัะฐะฒะธะปัะฝะฐั ะฐััะธัะตะบัััะฐ |
| **nsenter (ัะตะบััะธะน)** | ะััััะพ, ะฟััะผะพะน ะดะพัััะฟ, ะฝะตั ะฒัะตะผะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ | ะขัะตะฑัะตั privileged ัะตะถะธะผ |
| **Docker socket + docker run** | ะะฐะฑะพัะฐะตั ะฒะตะทะดะต | ะะตะดะปะตะฝะฝะตะต, ัะพะทะดะฐัั ะฒัะตะผะตะฝะฝัะต ะบะพะฝัะตะนะฝะตัั |
| **Docker Context (SSH)** | ะะตะทะพะฟะฐัะฝะตะต, ัะดะฐะปัะฝะฝะพะต ัะฟัะฐะฒะปะตะฝะธะต | ะกะปะพะถะฝะตะต ะฝะฐัััะพะนะบะฐ |
| **Docker API HTTP** | ะะตะท socket, ัะดะฐะปัะฝะฝะพ | ะขัะตะฑัะตั ะฝะฐัััะพะนะบะธ TLS |

---

## ๐ฏ ะัะพะณะพ

ะขะตะฟะตัั ัะบัะธะฟัั `UP_*.sh` ะบะพััะตะบัะฝะพ ะธ **ะฑััััะพ** ะฒัะฟะพะปะฝััััั ะฝะฐ ัะพัั-ะผะฐัะธะฝะต ัะตัะตะท `nsenter` ะฑะตะท ัะพะทะดะฐะฝะธั ะฒัะตะผะตะฝะฝัั ะบะพะฝัะตะนะฝะตัะพะฒ!
